/**
 * HTML5 Audio Visualizer Player min
 * HTML5音乐可视化播放器压缩版
 * 版本号:1.0.1
 * Author：PoppinRubo
 * License: MIT
 */
function Player(){var timer;var overtime;var Myself=this;Myself.button={prev:true,play:true,next:true,volume:true,progressControl:true};Myself.analyser=null;this.config=function(Object){Myself.playList=Object.playList;Myself.canvasId=Object.canvasId;Myself.autoPlay=Object.autoPlay;Myself.button=Object.button;Myself.event=Object.event;Myself.handle=0;createParts()};function windowAudioContext(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;try{Myself.audioContext=new AudioContext()}catch(e){console.log("您的浏览器不支持 AudioContext,信息:"+e)}}function createParts(){var audio=document.createElement("AUDIO");var player=document.getElementById("player");player.appendChild(audio);Myself.audio=audio;var control=document.getElementById("playerControl");var button=Myself.button;if(button.prev){var prevBtn=document.createElement("i");prevBtn.className="icon-previous";prevBtn.id="playPrev";prevBtn.title="上一首";prevBtn.innerHTML="&#xeaaf";control.appendChild(prevBtn);var playPrev=document.getElementById("playPrev");playPrev.onclick=function(){prev()}}if(button.play){var playBtn=document.createElement("i");playBtn.className="icon-play";playBtn.id="playControl";playBtn.title="播放";playBtn.innerHTML="&#xeaa8";playBtn.setAttribute("data","pause");control.appendChild(playBtn);var playControl=document.getElementById("playControl");playControl.onclick=function(){play()}}if(button.next){var nextBtn=document.createElement("i");nextBtn.className="icon-next";nextBtn.id="playNext";nextBtn.title="下一首";nextBtn.innerHTML="&#xeab0";control.appendChild(nextBtn);var playNext=document.getElementById("playNext");playNext.onclick=function(){next()}}if(button.volume){var volumeBox=document.createElement("div");volumeBox.id="volumeBox";control.appendChild(volumeBox);var volumeBtn=document.createElement("i");volumeBtn.className="icon-volume";volumeBtn.id="playVolume";volumeBtn.title="音量";playBtn.setAttribute("data","normal");volumeBtn.innerHTML="&#xeab3";volumeBox.appendChild(volumeBtn);var volumeBar=document.createElement("div");volumeBar.id="volumeBar";volumeBox.appendChild(volumeBar);var volumeSize=document.createElement("div");volumeSize.id="volumeSize";volumeBar.appendChild(volumeSize);volumeBar.onclick=function(event){volumeChange(event,volumeBar,volumeSize)};var volumeBtn=document.getElementById("playVolume");volumeBtn.onclick=function(){volume()}}var playerTime=document.getElementById("playerTime");playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%";Myself.playerTime=playerTime;if(Myself.button.progressControl){var progress=document.getElementById("progress");progress.style.cursor="pointer";progress.onclick=function(event){progressControl(event,progress)}}windowAudioContext();var playList=Myself.playList;Myself.audio.src=playList[0].mp3;var songInfo=document.getElementById("songInfo");var songTitle=document.createElement("div");songTitle.id="songTitle";songInfo.appendChild(songTitle);var album=document.createElement("div");album.id="album";songInfo.appendChild(album);var span=document.createElement("span");span.innerHTML="-";songInfo.appendChild(span);var artist=document.createElement("div");artist.id="artist";songInfo.appendChild(artist);Myself.nowPlay=0;updates();Myself.audio.volume=volumeGetCookie();if(Myself.autoPlay){play()}}function play(){if(Myself.button.play){var playBtn=document.getElementById("playControl");var data=playBtn.getAttribute("data")}if(Myself.audio.paused){Myself.audio.play();playBtn.setAttribute("data","play");playBtn.title="暂停";playBtn.innerHTML="&#xeaa9";timer=setInterval(function(){showTime();playerState()},1000);updates();if(Myself.handle==0){playHandle()}}else{Myself.audio.pause();playBtn.setAttribute("data","pause");playBtn.title="播放";playBtn.innerHTML="&#xeaa8";window.clearInterval(timer)}Myself.event({eventType:"play",describe:"播放/暂停"})}function updates(){var List=Myself.playList;var nowPlay=Myself.nowPlay;var songTitle=document.getElementById("songTitle");songTitle.innerHTML=List[nowPlay].title;songTitle.title="歌曲:"+List[nowPlay].title;var songAlbum=document.getElementById("album");songAlbum.innerHTML="("+List[nowPlay].album+")";songAlbum.title="所属专辑:"+List[nowPlay].title;var songArtist=document.getElementById("artist");songArtist.innerHTML=List[nowPlay].artist;songArtist.title="艺术家:"+List[nowPlay].artist}function playerState(){var state=Myself.audio.readyState;var playerState=document.getElementById("playerState");var songInfo=document.getElementById("songInfo");if(state==4){if(playerState!=null){songInfo.removeChild(playerState);window.clearTimeout(overtime)}}else{if(playerState==null){playerState=document.createElement("div");
    playerState.id="playerState";playerState.innerHTML="<i class='icon-music'>&#xe95f;</i>加载中……";songInfo.appendChild(playerState);overtime=setTimeout(function(){if(Myself.audio.readyState==0){playerState.innerHTML="加载失败!"}},120000)}}}function showTime(){if(Myself.audio.readyState==4){var duration=Myself.audio.duration;var currentTime=Myself.audio.currentTime;var surplusTime=duration-currentTime;var ratio=((currentTime/duration)*100).toFixed(1);ratio=ratio==100?100:ratio;function timeFormat(t){return Math.floor(t/60)+":"+(t%60/100).toFixed(2).slice(-2)}Myself.playerTime.innerHTML="-&nbsp;"+timeFormat(surplusTime)+"&nbsp;/&nbsp;"+timeFormat(duration)+"&nbsp;&nbsp;&nbsp;&nbsp;"+ratio+"%";document.getElementById("playerProgressBar").style.width=ratio+"%";if(ratio==100){next()}}else{Myself.playerTime.innerHTML="-&nbsp;00:00&nbsp;/&nbsp;00:00&nbsp;&nbsp;&nbsp;&nbsp;0%"}}function prev(){if(Myself.nowPlay==0){Myself.nowPlay=Myself.playList.length}Myself.nowPlay=Myself.nowPlay-1;Myself.audio.src=Myself.playList[Myself.nowPlay].mp3;window.clearInterval(timer);if(Myself.analyser!=null){drawSpectrum(Myself.analyser)}Myself.event({eventType:"prev",describe:"播放上一首"});play()}function next(){if(Myself.nowPlay==Myself.playList.length-1){Myself.nowPlay=-1}Myself.nowPlay=Myself.nowPlay+1;Myself.audio.src=Myself.playList[Myself.nowPlay].mp3;window.clearInterval(timer);if(Myself.analyser!=null){drawSpectrum(Myself.analyser)}Myself.event({eventType:"next",describe:"播放上一首"});play()}function volume(){if(Myself.button.volume){var volumeBtn=document.getElementById("playVolume");var data=volumeBtn.getAttribute("data");if(data=="normal"){volumeBtn.setAttribute("data","mute");volumeBtn.innerHTML="&#xeab3"}else{volumeBtn.setAttribute("data","normal");volumeBtn.innerHTML="&#xeab6"}}if(Myself.audio.muted){Myself.audio.muted=false}else{Myself.audio.muted=true}}function volumeChange(e,volumeBar,volumeSize){var offsetX=e.offsetX;var width=volumeBar.offsetWidth;var proportion=offsetX/width;volumeSize.style.width=(proportion*100)+"%";var size=proportion;Myself.audio.volume=size;volumeSetCookie(size)}function volumeSetCookie(size){document.cookie="playerVolume="+size}function volumeGetCookie(){var volumeSize=document.getElementById("volumeSize");var arr,reg=new RegExp("(^| )playerVolume=([^;]*)(;|$)");var volume=1;if(arr=document.cookie.match(reg)){volume=unescape(arr[2])}else{volume=0.5}volumeSize.style.width=volume*100+"%";return volume}function progressControl(e,progress){var offsetX=e.offsetX;var width=progress.offsetWidth;var proportion=offsetX/width;var duration=Myself.audio.duration;var playTime=duration*proportion;Myself.audio.currentTime=playTime}function playHandle(){windowAudioContext();var audioContext=Myself.audioContext;var analyser=audioContext.createAnalyser();var playData=audioContext.createMediaElementSource(Myself.audio);playData.connect(analyser);analyser.connect(audioContext.destination);drawSpectrum(analyser);Myself.analyser=analyser;Myself.handle=1}function drawSpectrum(analyser){var colorArray=["#f82466","#00FFFF","#AFFF7C","#FFAA6A","#6AD5FF","#D26AFF","#FF6AE6","#FF6AB8","#FF6A6A","#7091FF"];var colorRandom=Math.floor(Math.random()*colorArray.length);Myself.color=colorArray[colorRandom];var effectRandom=Math.floor(Math.random()*2);switch(effectRandom){case 0:bar(analyser);break;case 1:circular(analyser);break;default:bar(analyser)}}function bar(analyser){var canvas=document.getElementById(Myself.canvasId),cwidth=canvas.width,cheight=canvas.height-2,meterWidth=10,capHeight=2,capStyle="#FFFFFF",meterNum=1000/(10+2),ctx=canvas.getContext("2d"),capYPositionArray=[],gradient=ctx.createLinearGradient(0,0,0,300);gradient.addColorStop(1,Myself.color);var drawMeter=function(){var array=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(array);var step=Math.round(array.length/meterNum);ctx.clearRect(0,0,cwidth,cheight);for(var i=0;i<meterNum;i++){var value=array[i*step];if(capYPositionArray.length<Math.round(meterNum)){capYPositionArray.push(value)}ctx.fillStyle=capStyle;if(value<capYPositionArray[i]){ctx.fillRect(i*12,cheight-(--capYPositionArray[i]),meterWidth,capHeight)}else{ctx.fillRect(i*12,cheight-value,meterWidth,capHeight);capYPositionArray[i]=value}ctx.fillStyle=gradient;ctx.fillRect(i*12,cheight-value+capHeight,meterWidth,cheight)}requestAnimationFrame(drawMeter)};requestAnimationFrame(drawMeter)}function circular(analyser){var canvas=document.getElementById(Myself.canvasId),width=canvas.width,height=canvas.height,ctx=canvas.getContext("2d");var draw=function(){var array=new Uint8Array(128);analyser.getByteFrequencyData(array);ctx.clearRect(0,0,width,height);for(var i=0;i<(array.length);i++){var value=array[i];ctx.beginPath();ctx.arc(width/2,height/2,value,0,400,false);ctx.lineWidth=2;ctx.strokeStyle=(1,Myself.color);ctx.stroke();ctx.closePath()}requestAnimationFrame(draw)};requestAnimationFrame(draw)}};